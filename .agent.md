# AI Agent Context Document - Christmas Tree Designer

This document provides context for AI assistants working on this project.

## Project Overview

**Name**: Christmas Tree Designer  
**Type**: Progressive Web App (PWA)  
**Purpose**: Help users design and calculate dimensions for wooden Christmas trees made from stacked, rotatable wooden pieces

### Core Concept

The tree is constructed by:
1. Stacking rectangular wooden pieces vertically
2. Each piece has a center hole for a support rod
3. Pieces are cut at angles on both ends to create a triangular profile
4. Pieces get progressively shorter from bottom to top
5. Each piece can be rotated around the center rod to create patterns

## Tech Stack

- **Build Tool**: Vite 5.4.11
- **Framework**: React 19.2.1
- **Language**: TypeScript 5.5.3
- **3D Graphics**: React Three Fiber 9.4.2 + Three.js 0.181.2 + @react-three/drei 10.7.7
- **Styling**: Tailwind CSS 3.4.1
- **Node Version**: 20.12.1 (Note: Vite prefers 20.19+, but compatible)

## Project Structure

```
/Users/hmaritz/atlassian/chistmas/
├── .github/workflows/
│   └── deploy.yml          # GitHub Actions for deployment
├── public/
│   ├── manifest.json       # PWA manifest
│   ├── sw.js              # Service worker
│   ├── tree-icon.svg      # App icon
│   └── 404.html           # SPA redirect handler
├── src/
│   ├── components/
│   │   ├── AngledWoodPiece.tsx    # Custom 3D geometry for angled cuts
│   │   ├── TreePiece3D.tsx        # Individual tree piece renderer
│   │   ├── TreeViewer3D.tsx       # Main 3D scene
│   │   ├── InputForm.tsx          # Dimension input form
│   │   ├── CutList.tsx            # Material list and cut dimensions
│   │   └── ViewControls.tsx       # View mode and angle controls
│   ├── utils/
│   │   ├── treeCalculations.ts    # Core geometry calculations
│   │   └── woodTexture.ts         # Procedural wood texture generation
│   ├── App.tsx            # Main app component
│   ├── main.tsx           # Entry point + service worker registration
│   ├── index.css          # Global styles + Tailwind imports
│   └── vite-env.d.ts      # TypeScript environment definitions
├── vite.config.ts         # Vite configuration (includes base URL)
├── tsconfig.json          # TypeScript configuration
├── tailwind.config.js     # Tailwind CSS configuration
├── postcss.config.js      # PostCSS configuration
└── package.json           # Dependencies and scripts
```

## Key Files and Their Purposes

### Core Calculation Engine
**File**: `src/utils/treeCalculations.ts`

Contains the geometry calculation logic:
- **`calculateTree()`**: Main function that calculates all tree dimensions
  - Takes: `StockDimensions`, `TreeDimensions`, optional `manualAngleOverride`
  - Returns: `TreeCalculation` with pieces array, angles, material requirements
  - Key formula: `cutAngleDegrees = atan(2 * actualHeight / baseWidth) * 180 / PI`
    - Note the factor of 2 (tapers from center to edge, not full width)

**Important**: The angle calculation was corrected. See `ANGLE_CALCULATION_FIX.md` for details.

### 3D Visualization
**File**: `src/components/AngledWoodPiece.tsx`

Creates custom BufferGeometry for wooden pieces with angled cuts:
- Bottom face: Full length
- Top face: Shorter by `offset = height / tan(cutAngle)` on each side
- Creates trapezoidal prism shape
- 8 vertices (4 bottom, 4 top)

**File**: `src/components/TreeViewer3D.tsx`

Main 3D scene using React Three Fiber:
- Auto-centers camera on tree midpoint: `target={[0, midHeight, 0]}`
- Camera position adjusts based on tree height
- Uses `useEffect` to re-center when tree dimensions change

**File**: `src/utils/woodTexture.ts`

Procedural wood texture generation:
- **`createWoodTexture()`**: Generates a 512x512 canvas-based pine wood texture
  - Base color: Light tan/beige (#d4a574)
  - Grain colors: Medium and dark brown
  - Includes vertical grain lines with sine wave variation
  - Adds knots/imperfections with radial gradients
  - Subtle noise for realism
- **`createWoodNormalMap()`**: Creates a normal map for bump/depth effect
- **`PINE_COLORS`**: Exported color constants for consistency
- Textures are created once per piece using `useMemo()` for performance

### User Interface
**File**: `src/components/InputForm.tsx`

Input form with auto-calculation:
- Auto-calculates on mount using `useEffect`
- Auto-calculates on any input change
- Default values:
  - Stock: depth=90mm, height=35mm, length=2400mm
  - Tree: baseWidth=600mm, targetHeight=900mm

**File**: `src/components/ViewControls.tsx`

Controls for view mode and angle override:
- View modes: 'flat' (aligned) or 'rotated' (spiral pattern)
- Rotation angle slider (0-45°)
- Manual cut angle override toggle and input

## Configuration Details

### Base URL
**Critical**: Base URL is `/christmas-tree/` for GitHub Pages deployment
- Configured in: `vite.config.ts`
- Also referenced in: `public/sw.js`, `public/404.html`, `src/main.tsx`
- **Must match GitHub repository name exactly**

### Default Values
```typescript
// Stock dimensions
stockDepth: 90mm
stockHeight: 35mm
stockLength: 2400mm

// Tree dimensions
baseWidth: 600mm
targetHeight: 900mm

// View settings
viewMode: 'rotated'
rotationAngle: 25 degrees
```

### Scene Units
All dimensions are in millimeters, converted to scene units by dividing by 100:
```typescript
const scaleLength = piece.length / 100;  // mm to scene units
```

## Important Conventions

### Geometry Terminology
- **Depth**: Front-to-back dimension (Z-axis in 3D, constant from stock)
- **Height**: Thickness/vertical dimension (Y-axis in 3D, constant from stock)
- **Length**: Left-to-right dimension (X-axis in 3D, varies per piece)
- **Cut Angle**: Angle of the angled cuts on both ends

### Coordinate System
- **X-axis**: Length (left-right)
- **Y-axis**: Height (up-down, stacking direction)
- **Z-axis**: Depth (front-back)
- Origin at center of bottom piece

### Calculation Flow
1. User inputs → `calculateTree()`
2. Calculate number of layers: `floor(targetHeight / stockHeight)`
3. Calculate cut angle: `atan(2 * actualHeight / baseWidth)`
4. For each layer i (0 to n-1):
   - Layer height: `i * stockHeight`
   - Width at layer: `baseWidth * (1 - layerHeight / actualHeight)`
5. Sum total material needed

## Common Tasks

### Adding New Input Fields
1. Add state in `InputForm.tsx`
2. Update `handleSubmit()` to include new value
3. Update `TreeDimensions` or `StockDimensions` interface in `treeCalculations.ts`
4. Update `calculateTree()` to use new parameter
5. Update default value in initial `useState()`
6. Add to auto-calculation in `handleChange()`

### Modifying 3D Geometry
1. Edit `AngledWoodPiece.tsx` for piece shape
2. Edit `TreeViewer3D.tsx` for scene/camera
3. Edit `TreePiece3D.tsx` for individual piece rendering
4. Remember: scene units = mm / 100

### Changing Default Dimensions
Update in `InputForm.tsx`:
```typescript
const [stockDepth, setStockDepth] = useState<string>('90');
const [stockHeight, setStockHeight] = useState<string>('35');
// etc...
```

### Updating Deployment Base URL
If changing repository name, update in 4 places:
1. `vite.config.ts` - `base` property
2. `public/sw.js` - `BASE_PATH` constant
3. `public/404.html` - redirect URL
4. Documentation files

## Known Issues and Gotchas

### Node Version Warnings
The project uses Node 20.12.1 but Vite 5.4+ prefers 20.19+. This shows warnings but works fine. Safe to ignore.

### TypeScript Strict Mode
Project uses strict TypeScript. All component props must be typed.

### Service Worker
Service worker uses base path from `import.meta.env.BASE_URL` which Vite provides automatically.

### Camera Re-centering
Camera re-centers when calculation changes via `useEffect` with `controlsRef`. Don't remove the ref or useEffect will break auto-centering.

### Angle Calculation History
Original formula was incorrect (`atan(height / baseWidth)`). Corrected to `atan(2 * height / baseWidth)` because taper is from center to edge, not full width. See `ANGLE_CALCULATION_FIX.md`.

## State Management

### App.tsx State
```typescript
calculation: TreeCalculation | null         // Current tree calculation
viewMode: 'flat' | 'rotated'               // View mode
rotationAngle: number                       // Rotation between pieces (degrees)
manualCutAngle: number | undefined          // Manual angle override
useManualAngle: boolean                     // Whether to use override
stockDims: StockDimensions | null          // Cached for recalculation
treeDims: TreeDimensions | null            // Cached for recalculation
```

### Data Flow
```
InputForm → onCalculate() → App.handleCalculate() → calculateTree() → 
setState(calculation) → TreeViewer3D + CutList (re-render)
```

Manual angle toggle → `handleAngleOverrideChange()` → recalculate with override

## Build and Deploy

### Build Commands
```bash
npm run dev       # Dev server (port 3000)
npm run build     # Production build to dist/
npm run preview   # Preview production build
npm run deploy    # Manual deploy via gh-pages
```

### GitHub Actions
Workflow file: `.github/workflows/deploy.yml`
- Triggers on push to `master` branch
- Runs `npm ci` → `npm run build`
- Deploys to GitHub Pages via `actions/deploy-pages@v4`

### Deployment Checklist
1. Repository name must match base URL in `vite.config.ts`
2. Repository must be public
3. GitHub Pages enabled with source: "GitHub Actions"
4. Build must succeed locally before pushing

## Dependencies Explained

### Core
- `react` + `react-dom`: UI framework
- `typescript`: Type safety
- `vite`: Build tool and dev server

### 3D Graphics
- `three`: WebGL 3D library
- `@react-three/fiber`: React renderer for Three.js
- `@react-three/drei`: Helpful Three.js components (OrbitControls, Grid)
- `@types/three`: TypeScript definitions

### Styling
- `tailwindcss`: Utility-first CSS
- `autoprefixer`: CSS vendor prefixes
- `postcss`: CSS transformations

### Deployment
- `gh-pages`: Manual deployment to GitHub Pages branch

## Tips for AI Agents

1. **Always check base URL** when touching deployment files
2. **Scene unit conversion** - remember to divide mm by 100
3. **Angle calculation** - use the corrected formula with factor of 2
4. **Auto-calculation** - forms auto-calculate on change, maintain this UX
5. **Camera centering** - preserve the useEffect that updates camera target
6. **TypeScript strict** - all new code must type properly
7. **Mobile responsive** - test changes work on mobile viewport
8. **Default values** - maintain realistic defaults that show the app well

## Testing Checklist

When making changes, verify:
- [ ] `npm run build` succeeds
- [ ] No TypeScript errors
- [ ] 3D viewer renders correctly
- [ ] Camera centers on tree
- [ ] Hover tooltips work
- [ ] Input auto-calculation works
- [ ] Cut list updates correctly
- [ ] View mode toggle works
- [ ] Manual angle override works
- [ ] Mobile layout works (responsive)
- [ ] Service worker registers (check console)

## Contact & Resources

- **Documentation**: README.md, DEPLOYMENT.md, USAGE_EXAMPLES.md
- **Geometry Explanation**: GEOMETRY_EXPLANATION.md
- **Angle Fix Details**: ANGLE_CALCULATION_FIX.md
- **Quick Deploy**: QUICK_DEPLOY.md

Last Updated: 2025-12-08
